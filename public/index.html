<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon List</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <style>
        .pokemon-card {
            margin-bottom: 20px;
        }

        .modal-body img {
            max-width: 100%;
        }
    </style>
</head>

<body>
    <form id="filterForm">
        <div class="checkbox-rows" id="typeCheckboxes">
            <!-- Checkbox rows will be dynamically populated -->
        </div>
        <button type="button" onclick="submitForm()">Filter Pokémon</button>

    </form>

    <!-- Display total number of Pokémon -->
    <div id="totalPokemonInfo">
        <!-- Total Pokémon count will be dynamically updated -->
    </div>

    <div class="pokemon-container" id="pokemonContainer">
        <!-- Pokémon cards will be dynamically populated -->
    </div>

    <!-- Pagination Controls -->
    <div class="pagination" id="pagination">
        <!-- Pagination links will be dynamically updated -->
    </div>

    <!-- Modal structure -->
    <div class="modal fade" id="pokeModal" tabindex="-1" role="dialog" aria-labelledby="pokeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pokeModalLabel">Pokémon Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Pokémon details will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // Function to fetch Pokémon types and populate checkboxes
        async function getAllPokemonTypes() {
            try {
                const response = await fetch('/types'); // Fetch from your server's /types endpoint
                if (!response.ok) {
                    throw new Error('Failed to fetch Pokémon types');
                }
                const pokemonTypes = await response.json();
                return pokemonTypes;
            } catch (error) {
                console.error('Error fetching Pokémon types:', error);
                return [];
            }
        }

        // Function to dynamically populate checkboxes for Pokémon types
        async function populateTypes() {
            try {
                const types = await getAllPokemonTypes();
                console.log('Pokémon Types:', types); // Log the fetched types

                // Example: Populate checkboxes with fetched types
                const typeCheckboxes = document.getElementById('typeCheckboxes');
                types.forEach(type => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.classList.add('checkbox-row');
                    checkboxDiv.innerHTML = `
          <input type="checkbox" class="pokemon-checkbox" name="type" value="${type}" id="${type}">
          <label for="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</label>
        `;
                    typeCheckboxes.appendChild(checkboxDiv);
                });

            } catch (error) {
                console.error('Error populating types:', error);
                alert('Failed to fetch Pokémon types. Please try again.');
            }
        }

        // Call populateTypes to fetch and populate checkboxes on page load
        document.addEventListener('DOMContentLoaded', async function () {
            await populateTypes(); // Populate types checkboxes
            fetchPokemonData(); // Fetch Pokémon data initially
        });

        // Function to handle form submission and fetch Pokémon data based on selected types
async function fetchPokemonData(page = 1) {
  try {
    const checkboxes = document.querySelectorAll('.pokemon-checkbox:checked');
    const selectedTypes = Array.from(checkboxes).map(cb => cb.value);

    let url = `/pokemon?page=${page}`;
    if (selectedTypes.length > 0) {
      // Assuming selectedTypes are type IDs, not type names
      url += `&type=${selectedTypes.join(',')}`;
    }

    const response = await fetch(url);
    if (!response.ok) {
      throw new Error('Failed to fetch Pokémon data');
    }
    const data = await response.json();

    // Update total Pokémon count
    document.getElementById('totalPokemonInfo').innerHTML = `
      <p>Showing ${data.pokemonData.length} of ${data.totalPokemonCount}</p>
    `;

    // Update Pokémon cards
    const pokemonContainer = document.getElementById('pokemonContainer');
    pokemonContainer.innerHTML = '';
    data.pokemonData.forEach(pokemon => {
      const pokemonCard = document.createElement('div');
      pokemonCard.classList.add('pokemon-card');
      pokemonCard.innerHTML = `
        <h3>${pokemon.name}</h3>
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${pokemon.id}.png"
          alt="${pokemon.name}" />
        <button class="see-more-btn btn btn-primary" data-name="${pokemon.name}"
          data-id="${pokemon.id}">See More</button>
      `;
      pokemonContainer.appendChild(pokemonCard);
    });

    // Update pagination controls
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    // Calculate start and end page numbers to display
    let startPage = Math.max(1, page - 2);
    let endPage = Math.min(data.totalPages, startPage + 4);

    // Ensure exactly 5 pages are displayed, centered around the current page
    if (page <= 2) {
      endPage = Math.min(3, data.totalPages); // On page 1 or 2, show up to page 3
    } else if (page >= data.totalPages - 2) {
      startPage = Math.max(1, data.totalPages - 4); // Near the last page, show last 5 pages
    }

    // Display up to 5 page buttons
    for (let i = startPage; i <= endPage; i++) {
      pagination.innerHTML += `<a href="#" class="btn pagination-btn ${i === page ? 'active' : ''}" onclick="fetchPokemonData(${i})">${i}</a>`;
    }

    // Always show "Next" button if available
    if (data.hasNextPage) {
      pagination.innerHTML += `<a href="#" class="btn pagination-btn next" onclick="fetchPokemonData(${page + 1})">Next</a>`;
    }

  } catch (error) {
    console.error('Error fetching Pokémon data:', error);
    alert('Failed to fetch Pokémon data. Please try again.');
  }
}


        // Event listener for "See More" buttons
        document.addEventListener('click', async function (event) {
            if (event.target.classList.contains('see-more-btn')) {
                const pokemonName = event.target.dataset.name;
                const pokemonId = event.target.dataset.id;
                await showPokemonDetails(pokemonName, pokemonId);
            }
        });

        // Function to fetch and display Pokémon details in the modal
        async function showPokemonDetails(name, id) {
            try {
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${name}`);
                if (!response.ok) {
                    throw new Error('Pokémon not found');
                }
                const pokemon = await response.json();
                updateModalContent(pokemon);
            } catch (error) {
                console.error('Error fetching Pokémon details:', error.message);
                alert('Failed to fetch Pokémon details. Please try again.');
            }
        }

        // Function to update modal content with Pokémon details
        function updateModalContent(pokemon) {
            const modalTitle = document.querySelector('.modal-title');
            const modalBody = document.querySelector('.modal-body');

            modalTitle.textContent = pokemon.name.toUpperCase();
            modalBody.innerHTML = `
      <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${pokemon.id}.png" alt="${pokemon.name}" class="img-fluid">
      <div>
        <h3>Abilities</h3>
        <ul>
          ${pokemon.abilities.map(ability => `<li>${ability.ability.name}</li>`).join('')}
        </ul>
      </div>
      <div>
        <h3>Stats</h3>
        <ul>
          ${pokemon.stats.map(stat => `<li>${stat.stat.name}: ${stat.base_stat}</li>`).join('')}
        </ul>
      </div>
      <div>
        <h3>Types</h3>
        <ul>
          ${pokemon.types.map(type => `<li>${type.type.name}</li>`).join('')}
        </ul>
      </div>
    `;

            // Show the modal using jQuery (assuming jQuery is available)
            $('#pokeModal').modal('show');
        }

// Function to handle form submission and fetch Pokémon data based on selected types
async function submitForm() {
  try {
    await fetchPokemonData(); // Fetch Pokémon data based on selected types
  } catch (error) {
    console.error('Error submitting form:', error);
    alert('Failed to submit form. Please try again.');
  }
}

    </script>

</body>

</html>